<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Startlist Viewer — seurakohtainen</title>
<style>:root{--bg-body:#f7f9fb;--txt-body:#111;--bg-table:#fff;--border-table:#eef2f7;--bg-select:#fff;--border-select:#cbd5e1;--bg-link:#e2e8f0;--txt-link:#111;--bg-link-hover:#cbd5e1;--row-hover:#c1d6ea;--hint:#6b7280;--sorted:#ff0000;--rank1-txt:#111;
}@media (prefers-color-scheme:dark){:root{--bg-body:#121212;--txt-body:#e0e0e0;--bg-table:#1e1e1e;--border-table:#333;--bg-select:#2b2b2b;--border-select:#555;--bg-link:#2d3748;--txt-link:#e0e0e0;--bg-link-hover:#4a5568;--row-hover:#2c3e50;--hint:#a0aec0;--sorted:#00ff00;--rank1-txt:#000}}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;background:var(--bg-body);color:var(--txt-body)}header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}select,input{padding:6px 8px;border-radius:6px;border:1px solid var(--border-select);background:var(--bg-select);color:var(--txt-body)}table{border-collapse:collapse;width:100%;background:var(--bg-table);border-radius:8px;overflow:hidden}th,td{padding:8px 8px;text-align:left;border-bottom:1px solid var(--border-table)}th{cursor:pointer;user-select:none;position:relative}th .hint{font-size:12px;color:var(--hint);margin-left:6px}th.sorted::after{content:attr(data-order);position:absolute;right:10px;font-size:12px;color:var(--sorted)}tbody tr:hover{background:var(--row-hover)}.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.small{font-size:12px;color:#64748b}.rank-1{background-color:gold;color:var(--rank1-txt)}.rank-2{background-color:silver}.rank-3{background-color:#cd7f32}#classLinks{margin:12px 0;display:flex;flex-wrap:wrap;gap:6px}#classLinks a{padding:4px 8px;background:var(--bg-link);border-radius:6px;text-decoration:none;color:var(--txt-link);font-size:14px}#classLinks a:hover{color:#ff9f4b;background:var(--bg-link-hover)}  a:visited {  color:#ffb86c;
}
</style>

</head>
<body>
<header>
  <h2>Startlist Viewer</h2>
  <div class="controls">
    <label class="small">Seura:</label>
    <select id="clubSelect"><option>Kaikki seurat</option></select>
    <label class="small">Haku:</label>
    <input id="search" placeholder="nimi, nro, chip, luokka..." />
    <div class="controls" style="margin-top:12px;">
      <button id="exportCsv">Lataa näkymä CSV‑tiedona</button>
      <button onclick="selectedClass=null; render();">Näytä kaikki sarjat</button>

    </div>
  </div>
</header>

<div id="classLinks"></div>

<main>
  <table id="results">
    <thead id="tableHead"></thead>
    <tbody></tbody>
  </table>
</main>

<script>
  function makeKey(r) {
  const name = (r.name || (r.surname + ' ' + r.givenName) || '').trim().toLowerCase();
  return `${r.bibNumber||''}||${r.chip||''}||${name}`;
}
// Luo banneri tarvittaessa
function showEventIdWarning() {
  const banner = document.createElement('div');
  const baseUrl = window.location.origin + window.location.pathname;

   banner.innerHTML = `
    <strong>Tapahtuma puuttuu:</strong> URL-parametri <code>eventid</code> ei ole määritelty.<br>
    <p>Löydät tapahtuman UUID:n Navisport-sivulta seuraavasti:</p>
      <ol>
        <li>Avaa tapahtuman sivu Navisportissa.</li>
        <li>Kopioi URL-osoitteesta UUID (esim. <code>https://navisport.com/events/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>).</li>
        <li>Liitä se tämän sivun URL-osoitteen <code>?eventid=</code>-parametriin, esim. <code>https://${baseUrl}?eventid=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>.</li>
  `;
  document.body.prepend(banner);
}

document.addEventListener('DOMContentLoaded', () => { initApp(); });

const params = new URLSearchParams(window.location.search);
const eventId = params.get('event') || params.get('eventid') || params.get('eventId');
if (!eventId) {
  showEventIdWarning();
}
const DATA_URL = eventId ? `https://navisport.com/api/events/${eventId}` : 'startlist.json';

let rawData = null;
let rows = [];
let sortState = { key: null, asc: true };
let stageCount = 1;
let selectedClass = null;

function initApp(){
  document.addEventListener('click', e => {
    const th = e.target.closest('th'); if(!th) return; const key = th.dataset.key; if(!key) return;
    if(sortState.key===key){ sortState.asc=!sortState.asc; } else { sortState.key=key; sortState.asc=true; }
    render();
  });
  document.getElementById('search').addEventListener('input', ()=>render());
  document.getElementById('exportCsv').addEventListener('click', exportCsvHandler);
  loadData();
}

function parseName(name){
  if(!name) return {surname:'', givenName:''};
  const parts = name.trim().split(/\s+/);
  if(parts.length===1) return {surname:parts[0], givenName:''};
  return {surname:parts[0], givenName:parts.slice(1).join(' ')};
}

function formatTime(date){
  return date ? new Date(date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}) : '';
}

function parseDurationToSeconds(str){
  if(!str) return null;
  if(typeof str === 'number') return isFinite(str) ? Number(str) : null;
  str = String(str).trim();
  const parts = str.split(':').map(p=>p.trim());
  if(parts.length===1){ const n=Number(parts[0]); return isFinite(n)?n:null; }
  if(parts.length===2){ const mm=Number(parts[0]), ss=Number(parts[1]); if(isFinite(mm)&&isFinite(ss)) return mm*60+ss; }
  if(parts.length===3){ const hh=Number(parts[0]), mm=Number(parts[1]), ss=Number(parts[2]); if(isFinite(hh)&&isFinite(mm)&&isFinite(ss)) return hh*3600+mm*60+ss; }
  return null;
}

function formatSeconds(sec){
  if(sec==null || !isFinite(sec)) return '';
  sec = Math.round(sec);
  const hh = Math.floor(sec/3600);
  const mm = Math.floor((sec%3600)/60);
  const ss = sec%60;
  if(hh>0) return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

async function loadData(){
  try{
    const mainJson = await (await fetch(DATA_URL)).json();
    rawData = mainJson;
    eventState = mainJson.state || null;  
    const events = mainJson.events || [];
    stageCount = events.length || 1;
    const eventName = mainJson.name || (events[0]?.name) || 'Startlist Viewer';
    document.title = eventName + " – seuroittain" ;
    document.querySelector('h2').textContent = eventName;

    if(eventId){
      const link = document.createElement('a');
      link.href = `https://navisport.com/events/${eventId}`;
      link.target = "_blank";
      link.textContent = 'Viralliset tiedot';
      link.style.display = 'block'; link.style.marginTop = '16px';
      document.body.appendChild(link);
    }

    const mainCourseClasses = {};
    if(mainJson.courseClasses){ mainJson.courseClasses.forEach(c=>{ mainCourseClasses[c.id]=c.name; }); }

    const multistage = mainJson.eventKind === 'Multistage event' || (events.length>1);
    if(multistage){
      const allResults = [];
      for(const ev of events){
        try{
          const stageJson = await (await fetch(`https://navisport.com/api/events/${ev.id}`)).json();
          const stageCourseClasses = {};
          if(stageJson.courseClasses){ stageJson.courseClasses.forEach(c=>{ stageCourseClasses[c.id]=c.name; }); }
          allResults.push({ stageNumber: ev.stageNumber || (events.indexOf(ev)+1), results: stageJson.results||[], stageCourseClasses });
        } catch(errStage){
          console.warn('Alatapahtuman lataus epäonnistui', ev.id, errStage);
        }
      }
      prepareRowsMultistage(allResults, mainCourseClasses);
    } else {
      prepareRows(mainJson, mainCourseClasses);
    }

    createTableHeader();
    populateClubSelect();
    populateClassLinks();
    render();
  } catch(err){
    console.error(err);
    document.body.insertAdjacentHTML('afterbegin', `<div style="color:crimson">Virhe ladattaessa dataa: ${err.message}</div>`);
  }
}

function createTableHeader(){
  const head = document.getElementById('tableHead');
  head.innerHTML = '';
  const tr1 = document.createElement('tr'); // otsikot
  const tr2 = document.createElement('tr'); // alaotsikot (jos tarvitaan)
  tr1.innerHTML = `<th rowspan="2" data-key="className">Sarja <span class="hint">(sorttaa)</span></th>`;
  for(let i=0;i<stageCount;i++){
    if(eventState === "Complete"){
    tr1.innerHTML += `<th colspan="3">Stage ${i+1}</th>`;
    }else {
    tr1.innerHTML += `<th colspan="4">Stage ${i+1}</th>`;}
  }
  tr1.innerHTML += `<th rowspan="2" data-key="bibNumber">Nro</th><th rowspan="2" data-key="chip">Emit</th><th rowspan="2" data-key="surname">Sukunimi <span class="hint">(sorttaa)</span></th><th rowspan="2" data-key="givenName">Etunimi</th><th rowspan="2" data-key="club">Seura</th>`;
  if(stageCount > 1){
  tr1.innerHTML += `<th rowspan="2" data-key="totalTime">Yhteisaika</th><th rowspan="2" data-key="resultRank">Yhteissija</th>`;
  }
  // alimman rivin otsikot per stage
  for(let i=0;i<stageCount;i++){
    if(eventState === "Complete"){
      tr2.innerHTML += `<th data-key="stageTime${i+1}">Aika ${i+1}</th><th data-key="stageRank${i+1}">Sija ${i+1}</th><th data-key="stageStatus${i+1}">Tila ${i+1}</th>`;
    }else{
    tr2.innerHTML += `<th data-key="startTime${i+1}">Lähtö ${i+1} <span class="hint">(sorttaa)</span></th><th data-key="stageTime${i+1}">Aika ${i+1}</th><th data-key="stageRank${i+1}">Sija ${i+1}</th><th data-key="stageStatus${i+1}">Tila ${i+1}</th>`;
    }
  }
  head.appendChild(tr1);
  head.appendChild(tr2);
}

function prepareRows(json, mainCourseClasses){
  const list = json.results || [];
  rows = list.map(r=>{
    const {surname,givenName} = parseName(r.name||'');
    const className = r.className || mainCourseClasses[r.classId] || '';
    const rawTime = r.resultTime || r.time || (r.result && r.result.time) || r.totalTime || '';
    const totalSec = parseDurationToSeconds(rawTime) ?? parseDurationToSeconds(r.totalSeconds) ?? null;
    const rank = (r.status === "Ok") 
      ? (r.rank ?? r.resultRank ?? r.position ?? (r.result && (r.result.rank ?? r.result.position))) 
      : '';

    const status = r.status || r.resultStatus || '';
    
    return {
      id: r.id || null,
      bibNumber: r.bibNumber || '',
      chip: r.chip || '',
      surname, givenName,
      className,
      startTimes: [ formatTime(r.startTime) ],
      stageSeconds: [ totalSec ],
      stageTimes: [ totalSec!=null ? formatSeconds(totalSec) : (rawTime||'') ],
      stageRanks: [ rank ],
      stageStatuses: [ status ],
      totalSeconds: totalSec,
      totalTime: totalSec!=null ? formatSeconds(totalSec) : (rawTime||''),
      resultRank: rank,
      status,
      club: r.club || '',
      resultRankClass: ''   // lisätään paikka luokalle
    };
  });

  // --- Laske sarjakohtaiset sijoitukset ja värit ---
  const byClass = new Map();
  rows.forEach(r=>{
    const cls = r.className || '__no_class__';
    if(!byClass.has(cls)) byClass.set(cls, []);
    byClass.get(cls).push(r);
  });

  for(const [cls, list] of byClass.entries()){
  const withTotal = list.filter(r => r.totalSeconds != null && r.status === 'Ok');
  
  if(withTotal.length){
    withTotal.sort((a,b) => a.totalSeconds - b.totalSeconds);
    for(let i=0; i<withTotal.length; i++){
      withTotal[i].resultRank = i+1;

      // väritä sijoitus (kokonaissija)
      let rankClass = '';
      if(i===0) rankClass = 'rank-1';
      else if(i===1) rankClass = 'rank-2';
      else if(i===2) rankClass = 'rank-3';
      withTotal[i].resultRankClass = rankClass;

      // --- LISÄYS: aseta myös stage-kohtainen luokka stage 0:lle ---
      // varmista taulukkomuoto (kuten multistage käyttää)
      if(!Array.isArray(withTotal[i].stageRankClass)) withTotal[i].stageRankClass = [];
      withTotal[i].stageRankClass[0] = rankClass;

      // päivitä myös stageRanks[0] varmistaen että näkyy oikein
      if(Array.isArray(withTotal[i].stageRanks)){
        withTotal[i].stageRanks[0] = withTotal[i].stageRanks[0] || (i+1);
      } else {
        withTotal[i].stageRanks = [ i+1 ];
      }
    }
  }
}
}


function showValue(v) {
  return (v === null || v === undefined || v === '') ? '-' : v;
}
function prepareRowsMultistage(allResults, mainCourseClasses){
  const tempMap = {};
  const totalStages = stageResultsCount(allResults);

  for(const stageData of allResults){
    const stageNumber = stageData.stageNumber || (allResults.indexOf(stageData)+1);
    const idx = (typeof stageNumber === 'number') ? stageNumber-1 : (allResults.indexOf(stageData));
    const stageCourseClasses = stageData.stageCourseClasses || {};
    for(const r of stageData.results){
      const {surname,givenName} = parseName(r.name||'');
      const key = makeKey(r);
        if(!tempMap[key]){
        tempMap[key] = {
          id: r.id || null,
          bibNumber: r.bibNumber || '',
          chip: r.chip || '',
          surname, givenName,
          classNames: new Set(),
          startTimes: Array(totalStages).fill(''),
          stageSeconds: Array(totalStages).fill(null),
          stageTimes: Array(totalStages).fill(''),
          stageRanks: Array(totalStages).fill(''),
          stageStatuses: Array(totalStages).fill(''),
          totalSeconds: null,
          totalTime: '',
          resultRank: '',
          status: '',
          club: r.club || ''
        };
      }
      const item = tempMap[key];
      const className = r.className || stageCourseClasses[r.classId] || mainCourseClasses[r.classId] || '';
      if(className) item.classNames.add(className);
      item.startTimes[idx] = formatTime(r.startTime);
      const rawStageTime = r.resultTime || r.time || (r.result && r.result.time) || r.stageTime || '';
      const sec = parseDurationToSeconds(rawStageTime) ?? parseDurationToSeconds(r.seconds) ?? null;
      if(sec!=null){ item.stageSeconds[idx] = sec; item.stageTimes[idx] = formatSeconds(sec); }
      else if(rawStageTime) { item.stageTimes[idx] = rawStageTime; }
      item.stageRanks[idx] = r.rank || r.resultRank || (r.result && r.result.rank) || item.stageRanks[idx];

      item.stageStatuses[idx] = r.status || r.resultStatus || item.stageStatuses[idx];
      if(r.club) item.club = r.club;
    }
  }

  rows = Object.values(tempMap).map(item=>{
    item.className = Array.from(item.classNames).length===1 ? Array.from(item.classNames)[0] : Array.from(item.classNames).join(' / ');
// laske yhteisajan vain jos kaikilla stageilla on sekuntiarvo JA status "OK"
const allHaveTime = item.stageSeconds.every(s => s != null);
const allOk = item.stageStatuses.every(st => (st||'').toUpperCase() === 'OK');

if(allHaveTime && allOk){
  item.totalSeconds = item.stageSeconds.reduce((a,b)=>a+b,0);
  item.totalTime = formatSeconds(item.totalSeconds);
  item.status = 'OK';
} else {
  item.totalSeconds = null;
  // näytä kuitenkin mahdolliset osatulosajat selkeyden vuoksi
  item.totalTime = item.stageTimes.map(t => t||'').join(' | ');
  item.status = item.stageStatuses.filter(Boolean).join(' | ');
}

item.resultRank = '';

    item.resultRank = ''; item.status = item.stageStatuses.filter(Boolean).join(' | ');
    item.stageTimes = item.stageTimes.map(t => t||'');
    return item;
  });

  // Hyödynnetään pääeventin (rawData.results) valmiita totalTime/totalSeconds/sijoituksia jos annettu
  if(rawData && Array.isArray(rawData.results) && rawData.results.length){
    const mainMap = new Map();
    for(const r of rawData.results){
      const key = r.id ? `ID_${r.id}` : `${r.bibNumber||''}||${r.chip||''}||${r.name||''}`;
      const totalSec = parseDurationToSeconds(r.resultTime) ?? parseDurationToSeconds(r.totalTime) ?? parseDurationToSeconds(r.totalSeconds) ?? null;
      mainMap.set(key, { totalSec, rank: r.rank || r.resultRank || r.position || (r.result && (r.result.rank || r.result.position)) || null,  status: r.status || r.resultStatus || null });
   
    }
    rows.forEach(row=>{
      const key = row.id ? `ID_${row.id}` : `${row.bibNumber||''}||${row.chip||''}||${row.surname + ' ' + row.givenName}`;
      const m = mainMap.get(key);
      if(m){
        if(m.totalSec!=null){ row.totalSeconds = m.totalSec; row.totalTime = formatSeconds(m.totalSec); }
        if(m.rank) row.resultRank = m.rank;
        if(m.status) row.status = m.status;
      }
    });
  }

  // Laske per-stage sijoitukset sarjakohtaisesti (jos stageSeconds löytyy)
// --- Laske stage-kohtaiset sijoitukset ja värit ---
for(let stageIdx=0; stageIdx<stageCount; stageIdx++){
  const byClass = new Map();
  rows.forEach(r=>{
    const cls = r.className || '__no_class__';
    if(!byClass.has(cls)) byClass.set(cls, []);
    byClass.get(cls).push(r);
  });

  for(const [cls, list] of byClass.entries()){
    const withTime = list.filter(r=>r.stageSeconds[stageIdx] != null && (r.stageStatuses[stageIdx]||'').toUpperCase()==='OK');
    if(withTime.length){
      withTime.sort((a,b)=>a.stageSeconds[stageIdx]-b.stageSeconds[stageIdx]);
      for(let i=0;i<withTime.length;i++){
        let rankClass = '';
        if(i===0) rankClass='rank-1';
        else if(i===1) rankClass='rank-2';
        else if(i===2) rankClass='rank-3';
        withTime[i].stageRanks[stageIdx] = i+1; // päivitä sijoitus
        withTime[i].stageRankClass = withTime[i].stageRankClass || [];
        withTime[i].stageRankClass[stageIdx] = rankClass; // aseta väri
      }
    }
  }
}

  // Laske yhteissijat sarjakohtaisesti jos totalSeconds on olemassa
  const byClass2 = new Map();
  rows.forEach(r=>{
    const cls = r.className || '__no_class__';
    if(!byClass2.has(cls)) byClass2.set(cls, []);
    byClass2.get(cls).push(r);
  });
// --- resultRank ja soluväritys ---
for(const [cls, list] of byClass2.entries()){
  const withTotal = list.filter(r=>r.totalSeconds!=null); // vain valmiit rivit
  if(withTotal.length){
    withTotal.sort((a,b)=>a.totalSeconds-b.totalSeconds);
    for(let i=0;i<withTotal.length;i++){
      withTotal[i].resultRank = i+1;

      // lisätään solutasoinen väriluokka
      let rankClass = '';
      if(i===0) rankClass = 'rank-1';
      else if(i===1) rankClass = 'rank-2';
      else if(i===2) rankClass = 'rank-3';
      withTotal[i].resultRankClass = rankClass;
    }
  }
}

}

function stageResultsCount(allResults){ return allResults.length || 1; }

function populateClubSelect(){
  const sel = document.getElementById('clubSelect'); sel.innerHTML = '<option>Kaikki seurat</option>';
  const clubs = Array.from(new Set(rows.map(r=>r.club).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  clubs.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
  sel.addEventListener('change', ()=>render());
}

function populateClassLinks(){
  const container = document.getElementById('classLinks');
  container.innerHTML = '';
  const classes = Array.from(new Set(rows.map(r=>r.className).filter(Boolean)))
    .sort((a,b)=>a.localeCompare(b));
  classes.forEach(cn=>{
    const a = document.createElement('a');
    a.href='#';
    a.textContent = cn;
    a.addEventListener('click', e=>{
      e.preventDefault();
      selectedClass = cn;   // valitaan tarkka sarja
      render();
    });
    container.appendChild(a);
  });
}


function render(){
  const selClub = document.getElementById('clubSelect').value;
  const q = document.getElementById('search').value.trim().toLowerCase();
  let filtered = rows.filter(r=>{
  if(selClub && selClub!=='Kaikki seurat' && r.club!==selClub) return false;
  if(selectedClass && r.className !== selectedClass) return false; // tarkka match
  if(!q) return true;
  return [r.surname,r.givenName,String(r.bibNumber),r.chip,r.className,r.club,r.totalTime,r.resultRank,r.status]
    .some(v=>String(v||'').toLowerCase().includes(q));
});


  if(sortState.key){
    const k = sortState.key;
    filtered.sort((a,b)=>{
      let va,vb;
      if(k.startsWith('startTime')){ const idx=parseInt(k.replace('startTime',''),10)-1; va=a.startTimes[idx]||''; vb=b.startTimes[idx]||''; }
      else if(k.startsWith('stageTime')){ const idx=parseInt(k.replace('stageTime',''),10)-1; va=a.stageSeconds[idx]!=null?a.stageSeconds[idx]:(a.stageTimes[idx]||''); vb=b.stageSeconds[idx]!=null?b.stageSeconds[idx]:(b.stageTimes[idx]||''); }
      else if(k.startsWith('stageRank')){ const idx=parseInt(k.replace('stageRank',''),10)-1; va=a.stageRanks[idx]||''; vb=b.stageRanks[idx]||''; }
      else if(k === 'totalTime'){ va = a.totalSeconds!=null ? a.totalSeconds : (a.totalTime || ''); vb = b.totalSeconds!=null ? b.totalSeconds : (b.totalTime || ''); }
      else{ va = a[k]; vb = b[k]; }
      if(typeof va === 'string') va = va.toLowerCase();
      if(typeof vb === 'string') vb = vb.toLowerCase();
      if (va === '-' || va === '') return 1;
      if (vb === '-' || vb === '') return -1;
      if(va < vb) return sortState.asc ? -1 : 1;
      if(va > vb) return sortState.asc ? 1 : -1;
      return 0;
    });
  }

  const tbody = document.querySelector('#results tbody'); tbody.innerHTML = '';
  for(const r of filtered){
    const tr=document.createElement('tr');
    const rankClass = r.resultRankClass ? ` class="${r.resultRankClass}"` : '';
    let html = `<td>${r.className||''}</td>`;
    for(let i=0;i<stageCount;i++){
  const rankClass = r.stageRankClass && r.stageRankClass[i] ? r.stageRankClass[i] : '';
  if(eventState != "Complete"){
  html += `<td>${showValue(r.startTimes[i])}</td>`;
  }
  html += `<td>${showValue(r.stageTimes[i])}</td>`;
  html += `<td class="${rankClass}">${showValue(r.stageRanks[i])}</td>`;
  html += `<td>${showValue(r.stageStatuses[i])}</td>`;
}

    html += `<td>${r.bibNumber||''}</td><td>${r.chip||''}</td><td>${r.surname||''}</td><td>${r.givenName||''}</td><td>${r.club||''}</td>`;
    //html += `<td>${r.totalTime || ''}</td><td>${r.resultRank || ''}</td><td>${r.status || ''}</td>`;
    if(stageCount > 1){
    html += `<td>${r.totalTime || ''}</td><td${rankClass}>${showValue(r.resultRank)}</td>`;
    }

    tr.innerHTML = html;
    tbody.appendChild(tr);
  }

  document.querySelectorAll('th').forEach(th=>{ th.classList.remove('sorted'); th.removeAttribute('data-order'); });
  if(sortState.key){
    const header = document.querySelector(`th[data-key="${sortState.key}"]`);
    if(header){ header.classList.add('sorted'); header.setAttribute('data-order', sortState.asc ? '▲' : '▼'); }
  }
}

function rowsToCsv(data){
  const header = ["Sarja luokka"];
  for(let i=0;i<stageCount;i++){
    header.push(`Lähtö ${i+1}`, `Aika ${i+1}`, `Sija ${i+1}`, `Tila ${i+1}`);
  }
  header.push("Nro","Emit","Sukunimi","Etunimi","Seura","Yhteisaika","Yhteissija","Tila");
  const rowsCsv = data.map(r=>{
    const row = [ r.className||'' ];
    for(let i=0;i<stageCount;i++){
      row.push(r.startTimes[i]||'', r.stageTimes[i]||'', r.stageRanks[i]||'', r.stageStatuses[i]||'');
    }
    row.push(r.bibNumber||'', r.chip||'', r.surname||'', r.givenName||'', r.club||'', r.totalTime||'', r.resultRank||'', r.status||'');
    return row;
  });
  const escape = v => { const s = String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; };
  const csvLines = [ header.map(escape).join(',') ];
  rowsCsv.forEach(row => csvLines.push(row.map(escape).join(',')));
  return csvLines.join('\n');
}

function downloadCsv(filename, csvContent){
  const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function exportCsvHandler(){
  const selClub = document.getElementById('clubSelect').value;
  const q = document.getElementById('search').value.trim().toLowerCase();
  const filtered = rows.filter(r=>{
    if(selClub && selClub!=='Kaikki seurat' && r.club!==selClub) return false;
    if(!q) return true;
    return [r.surname,r.givenName,String(r.bibNumber),r.chip,r.className,r.club,r.totalTime,r.resultRank,r.status]
      .some(v=>String(v||'').toLowerCase().includes(q));
  });

  if(sortState.key){
    const k = sortState.key;
    filtered.sort((a,b)=>{
      let va,vb;
      if(k.startsWith('startTime')){ const idx=parseInt(k.replace('startTime',''),10)-1; va=a.startTimes[idx]||''; vb=b.startTimes[idx]||''; }
      else if(k.startsWith('stageTime')){ const idx=parseInt(k.replace('stageTime',''),10)-1; va=a.stageSeconds[idx]!=null?a.stageSeconds[idx]:(a.stageTimes[idx]||''); vb=b.stageSeconds[idx]!=null?b.stageSeconds[idx]:(b.stageTimes[idx]||''); }
      else if(k.startsWith('stageRank')){ const idx=parseInt(k.replace('stageRank',''),10)-1; va=a.stageRanks[idx]||''; vb=b.stageRanks[idx]||''; }
      else if(k === 'totalTime'){ va = a.totalSeconds!=null ? a.totalSeconds : (a.totalTime || ''); vb = b.totalSeconds!=null ? b.totalSeconds : (b.totalTime || ''); }
      else{ va = a[k]; vb = b[k]; }
      if(typeof va === 'string') va = va.toLowerCase();
      if(typeof vb === 'string') vb = vb.toLowerCase();
      if(va < vb) return sortState.asc ? -1 : 1;
      if(va > vb) return sortState.asc ? 1 : -1;
      return 0;
    });
  }

  const csv = rowsToCsv(filtered);
  const filename = `startlist_${new Date().toISOString().slice(0,10)}.csv`;
  downloadCsv(filename, csv);
}
</script>
</body>
</html>
